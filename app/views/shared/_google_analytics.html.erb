<% if Rails.env == "production"  %>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=<%= google_analytics_key %>"></script>
  <%= javascript_tag nonce: true, type: 'text/javascript' do %>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', '<%= google_analytics_key %>');

    document.addEventListener('DOMContentLoaded', function() {
      var breadcrumbs = document.querySelector('.govuk-breadcrumbs');
      if (breadcrumbs) { title = breadcrumbs.innerText.replace(/\n/g, '/'); }
      else { title = document.title; }

      gtag('event', 'pageview', {
        send_to: '<%= google_analytics_key %>',
        page_title: title,
        event_label: document.title
      });

      document.querySelectorAll('a[data-outgoing-link]').forEach(function(node) {
        node.addEventListener('click', function(event) {
          var target = event.currentTarget;
          gtag('event', target.innerText, {
            event_category: 'outbound',
            event_label: target.dataset.outgoingPage,
            event_action: target.href,
            page_title: target.innerText,
          });
        });
      });
    });
  <%- end %>
  <!-- End Google Analytics -->
<% end %>
